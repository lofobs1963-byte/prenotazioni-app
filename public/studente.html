<!DOCTYPE html>
<html>
<head>
  <title>Area Studente</title>

  <style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  background-color: #f4f6f9;
}

/* ===== TOP BAR ===== */

.top-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  max-width: 1100px;
  margin: 30px auto 10px auto;
  padding: 0 10px;
}

.page-title {
  font-size: 28px;
  font-weight: 600;
  margin: 0;
  color: #333;
}

.logout-btn {
  background-color: #ff4d4d;
  color: white;
  border: none;
  padding: 10px 18px;
  font-size: 14px;
  border-radius: 6px;
  cursor: pointer;
  transition: 0.2s ease;
}

.logout-btn:hover {
  background-color: #e60000;
  transform: scale(1.05);
}

.logout-btn:active {
  transform: scale(0.98);
}

/* ===== SELECT PROFESSORE ===== */

.prof-container {
  display: flex;
  justify-content: center;
  margin: 30px 0 10px 0;
}

#professore {
  font-size: 18px;
  padding: 12px 20px;
  border-radius: 8px;
  border: 2px solid #4da6ff;
  min-width: 260px;
  cursor: pointer;
  transition: 0.2s ease;
}

#professore:hover {
  border-color: #1e88e5;
}

#professore:focus {
  outline: none;
  box-shadow: 0 0 8px rgba(77,166,255,0.5);
}

/* ===== LEGENDA ===== */

.legend {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 25px;
  margin: 10px 0 25px 0;
}

.legend-item {
  display: flex;
  align-items: center;
  font-size: 14px;
}

.dot {
  height: 14px;
  width: 14px;
  border-radius: 50%;
  display: inline-block;
  margin-right: 8px;
}

.libero-dot {
  background-color: #b6fcb6;
}

.occupato-dot {
  background-color: #ff7b7b;
}

.mio-dot {
  background-color: #4da6ff;
}

/* ===== CALENDARIO ===== */

#calendar {
  width: 100%;
  max-width: 1100px;
  margin: 0 auto 40px auto;
  display: flex;
  justify-content: center;
}

#calendar table {
  border-collapse: separate;
  border-spacing: 6px;
}

th, td {
  border: 1px solid #ccc;
  padding: 8px;
  text-align: center;
  min-width: 80px;
  border-radius: 6px;
  transition: 0.15s;
}

th {
  background-color: #f2f2f2;
  font-weight: 600;
}

.ora {
  font-weight: bold;
  background-color: #fafafa;
}

/* ===== SLOT COLORI ===== */

.libero {
  background-color: #b6fcb6;
  cursor: pointer;
}

.libero:hover {
  transform: scale(1.05);
}

.occupato {
  background-color: #ff7b7b;
}

.mio {
  background-color: #4da6ff;
  color: white;
  font-weight: bold;
  cursor: pointer;
}
  </style>
</head>

<body>

<div class="top-bar">
  <h1 class="page-title">Area Studente</h1>
  <button class="logout-btn" onclick="logout()">Logout</button>
</div>

<div class="prof-container">
  <select id="professore" onchange="caricaSlot()"></select>
</div>

<!-- ðŸ‘‡ LEGENDA QUI -->
<div class="legend">
  <div class="legend-item">
    <span class="dot libero-dot"></span> Libero
  </div>
  <div class="legend-item">
    <span class="dot occupato-dot"></span> Occupato
  </div>
  <div class="legend-item">
    <span class="dot mio-dot"></span> Tuo
  </div>
</div>

<div id="calendar"></div>


<script>

const token = localStorage.getItem("accessToken");

if (!token) {
  window.location.href = "/login.html";
}

function logout() {
  localStorage.removeItem("accessToken");
  localStorage.removeItem("refreshToken");
  window.location.href = "/login.html";
}

// =========================
// CARICA PROFESSORI
// =========================

async function caricaProfessori() {

  const res = await fetch("/api/professori", {
    headers: { "Authorization": "Bearer " + token }
  });

 if (res.status === 401) {
  logout();
  return;
}

  const professori = await res.json();

  const select = document.getElementById("professore");
  select.innerHTML = "<option value=''>Seleziona professore</option>";

  professori.forEach(p => {
    const option = document.createElement("option");
    option.value = p.id;
    option.textContent = p.nome;
    select.appendChild(option);
  });
}

// =========================
// CARICA SLOT IN FORMATO CALENDARIO
// =========================

async function caricaSlot() {

  const professore_id = document.getElementById("professore").value;

  if (!professore_id) {
    document.getElementById("calendar").innerHTML = "";
    return;
  }

  const res = await fetch("/api/slots?professore_id=" + professore_id, {
    headers: { "Authorization": "Bearer " + token }
  });

  const data = await res.json();

  // =========================
  // GENERA LUN-VEN SETTIMANA CORRENTE (NO TIMEZONE BUG)
  // =========================

// =========================
// GENERA LUN-VEN SETTIMANA CORRENTE (SENZA BUG)
// =========================

const oggi = new Date();
const lunedi = new Date(oggi);

const giornoSettimana = oggi.getDay();
const diff = (giornoSettimana === 0 ? -6 : 1) - giornoSettimana;
lunedi.setDate(oggi.getDate() + diff);

const giorni = [];
const etichette = ["LUN", "MAR", "MER", "GIO", "VEN"];

for (let i = 0; i < 5; i++) {
  const d = new Date(lunedi);
  d.setDate(lunedi.getDate() + i);

  const yyyy = d.getFullYear();
  const mm = String(d.getMonth() + 1).padStart(2, "0");
  const dd = String(d.getDate()).padStart(2, "0");

  giorni.push({
    data: `${yyyy}-${mm}-${dd}`,
    label: etichette[i]
  });
}

  // =========================
  // GENERA ORARI FISSI 12:00-19:00
  // =========================

  function generaOrari() {
    const orari = [];
    let ora = 12;
    let minuti = 0;

    while (ora < 19 || (ora === 19 && minuti === 0)) {
      const h = String(ora).padStart(2, "0");
      const m = String(minuti).padStart(2, "0");
      orari.push(`${h}:${m}`);

      minuti += 15;
      if (minuti === 60) {
        minuti = 0;
        ora++;
      }
    }

    return orari;
  }

  const orari = generaOrari();

  // =========================
  // COSTRUZIONE TABELLA
  // =========================

  const calendarDiv = document.getElementById("calendar");
  calendarDiv.innerHTML = "";

  const table = document.createElement("table");

  // HEADER
  const headerRow = document.createElement("tr");
headerRow.innerHTML =
  "<th>Ora</th>" +
  giorni.map(g => `<th>${g.label}</th>`).join("");

  table.appendChild(headerRow);

  // RIGHE
  orari.forEach(ora => {
    const row = document.createElement("tr");
    let rowHTML = `<td class="ora">${ora}</td>`;

 giorni.forEach(g => {

const slot = data.find(s => {
  const dataDB = s.giorno.split("T")[0];  // elimina eventuale parte oraria
  return dataDB === g.data && s.ora_inizio === ora;
});

      if (!slot) {
        rowHTML += "<td style='background:#f0f0f0; opacity:0.4;'></td>";
      } else {

        let classe = "";
        let simbolo = "";

        if (slot.mio) {
          classe = "mio";
          simbolo = "ðŸ”µ";
        } else if (slot.prenotato == 0) {
          classe = "libero";
          simbolo = "ðŸŸ¢";
        } else {
          classe = "occupato";
          simbolo = "ðŸ”´";
        }

        rowHTML += `<td class="${classe}" data-id="${slot.id}">${simbolo}</td>`;
      }
    });

    row.innerHTML = rowHTML;
    table.appendChild(row);
  });

  calendarDiv.appendChild(table);

  // CLICK HANDLER
  calendarDiv.querySelectorAll("td[data-id]").forEach(cell => {
    cell.onclick = () => {
      const id = cell.dataset.id;
      const slot = data.find(s => s.id == id);

      if (slot.mio) {
        if (confirm("Vuoi annullare la prenotazione?")) {
          annulla(id);
        }
      } else if (slot.prenotato == 0) {
        if (confirm("Vuoi prenotare questo slot?")) {
          prenota(id);
        }
      }
    };
  });
}
// =========================
// PRENOTA
// =========================

async function prenota(slotId) {
  const res = await fetch("/api/prenota", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + token
    },
    body: JSON.stringify({ slotId })
  });

  const data = await res.json();

  if (res.ok) {
    caricaSlot();
  } else {
    alert(data.error);
  }
}

// =========================
// ANNULLA
// =========================

async function annulla(slotId) {
  const res = await fetch("/api/annulla", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + token
    },
    body: JSON.stringify({ slotId })
  });

  const data = await res.json();

  if (res.ok) {
    caricaSlot();
  } else {
    alert(data.error);
  }
}



caricaProfessori();

</script>

</body>
</html>
