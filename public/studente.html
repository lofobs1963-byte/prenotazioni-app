<!DOCTYPE html>
<html>
<head>
  <title>Area Studente</title>

  <style>
    body {
      font-family: Arial, sans-serif;
    }

    table {
      border-collapse: collapse;
      margin-top: 20px;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
      min-width: 80px;
    }

    th {
      background-color: #f2f2f2;
    }

    .libero {
      background-color: #b6fcb6;
      cursor: pointer;
    }

    .occupato {
      background-color: #ff7b7b;
    }

    .mio {
      background-color: orange;
      cursor: pointer;
    }

    .ora {
      font-weight: bold;
      background-color: #fafafa;
    }
  </style>
</head>

<body>

<h2>Area Studente</h2>
<button onclick="logout()">Logout</button>

<br><br>

<select id="professore" onchange="caricaSlot()"></select>

<div id="calendar"></div>

<script>

const token = localStorage.getItem("accessToken");

if (!token) {
  window.location.href = "/login.html";
}

function logout() {
  localStorage.removeItem("accessToken");
  localStorage.removeItem("refreshToken");
  window.location.href = "/login.html";
}

// =========================
// CARICA PROFESSORI
// =========================

async function caricaProfessori() {
  const res = await fetch("/api/professori", {
    headers: { "Authorization": "Bearer " + token }
  });

  const professori = await res.json();

  const select = document.getElementById("professore");
  select.innerHTML = "<option value=''>Seleziona professore</option>";

  professori.forEach(p => {
    const option = document.createElement("option");
    option.value = p.id;
    option.textContent = p.nome;
    select.appendChild(option);
  });
}

// =========================
// CARICA SLOT IN FORMATO CALENDARIO
// =========================

async function caricaSlot() {

  const professore_id = document.getElementById("professore").value;

  if (!professore_id) {
    document.getElementById("calendar").innerHTML = "";
    return;
  }

  const res = await fetch("/api/slots?professore_id=" + professore_id, {
    headers: { "Authorization": "Bearer " + token }
  });

  const data = await res.json();

  // Raggruppa per giorno
  const giorni = [...new Set(data.map(s => s.giorno))].sort();
  const orari = [...new Set(data.map(s => s.ora_inizio))].sort();

  const calendarDiv = document.getElementById("calendar");
  calendarDiv.innerHTML = "";

  const table = document.createElement("table");

  // HEADER
  const headerRow = document.createElement("tr");
  headerRow.innerHTML = "<th>Ora</th>" + giorni.map(g => `<th>${g}</th>`).join("");
  table.appendChild(headerRow);

  // RIGHE
  orari.forEach(ora => {
    const row = document.createElement("tr");
    let rowHTML = `<td class="ora">${ora}</td>`;

    giorni.forEach(giorno => {
      const slot = data.find(s => s.giorno === giorno && s.ora_inizio === ora);

      if (!slot) {
        rowHTML += "<td></td>";
      } else {

        let classe = "";
        let simbolo = "";

        if (slot.mio) {
          classe = "mio";
          simbolo = "ðŸŸ ";
        } else if (slot.prenotato == 0) {
          classe = "libero";
          simbolo = "ðŸŸ¢";
        } else {
          classe = "occupato";
          simbolo = "ðŸ”´";
        }

        rowHTML += `<td class="${classe}" data-id="${slot.id}">${simbolo}</td>`;
      }
    });

    row.innerHTML = rowHTML;
    table.appendChild(row);
  });

  calendarDiv.appendChild(table);

  // CLICK HANDLER
  calendarDiv.querySelectorAll("td[data-id]").forEach(cell => {
    cell.onclick = () => {
      const id = cell.dataset.id;
      const slot = data.find(s => s.id == id);

      if (slot.mio) {
        annulla(id);
      } else if (slot.prenotato == 0) {
        prenota(id);
      }
    };
  });
}

// =========================
// PRENOTA
// =========================

async function prenota(slotId) {
  const res = await fetch("/api/prenota", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + token
    },
    body: JSON.stringify({ slotId })
  });

  const data = await res.json();

  if (res.ok) {
    caricaSlot();
  } else {
    alert(data.error);
  }
}

// =========================
// ANNULLA
// =========================

async function annulla(slotId) {
  const res = await fetch("/api/annulla", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + token
    },
    body: JSON.stringify({ slotId })
  });

  const data = await res.json();

  if (res.ok) {
    caricaSlot();
  } else {
    alert(data.error);
  }
}

caricaProfessori();

</script>

</body>
</html>
