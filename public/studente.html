<!DOCTYPE html>
<html>
<head>
  <title>Area Studente</title>

  <style>
    body {
      font-family: Arial, sans-serif;
    }

   table {
  border-collapse: separate;
  border-spacing: 6px;
}

th, td {
  border: none;
  padding: 10px;
  border-radius: 6px;
  transition: 0.15s;
}

.libero:hover {
  transform: scale(1.05);
}

    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
      min-width: 80px;
    }

    th {
      background-color: #f2f2f2;
    }

    .libero {
      background-color: #b6fcb6;
      cursor: pointer;
    }

    .occupato {
      background-color: #ff7b7b;
    }

   .mio {
  background-color: #4da6ff;   /* azzurro */
  color: white;
  font-weight: bold;
  cursor: pointer;
}

    .ora {
      font-weight: bold;
      background-color: #fafafa;
    }
	
	#calendar {
  width: 100%;
  max-width: 1100px;
  margin: 30px auto;
  font-family: Arial, sans-serif;
}

.calendar-header {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  text-align: center;
  font-weight: bold;
  margin-bottom: 10px;
}

#calendar-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 10px;
}

/* Slot base */
.slot {
  padding: 8px;
  border-radius: 6px;
  text-align: center;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.2s ease;
  border: 1px solid #ddd;
}

/* Libero */
.slot.free {
  background-color: #e8f5e9;
}

.slot.free:hover {
  background-color: #c8e6c9;
  transform: scale(1.05);
}

/* Occupato */
.slot.booked {
  background-color: #ffcdd2;
  cursor: not-allowed;
  opacity: 0.7;
}

/* Mio */
.slot.mine {
  background-color: #bbdefb;
}

.slot.mine:hover {
  background-color: #90caf9;
}
  </style>
</head>

<body>

<h2>Area Studente</h2>
<button onclick="logout()">Logout</button>

<br><br>

<select id="professore" onchange="caricaSlot()"></select>



<div id="calendar"></div>


<div style="margin-top:15px;">
  <span style="background:#b6fcb6;padding:5px;"> Libero </span>
  <span style="background:#ff7b7b;padding:5px;"> Occupato </span>
  <span style="background:#4da6ff;color:white;padding:5px;"> Tuo </span>
</div>


<script>

const token = localStorage.getItem("accessToken");

if (!token) {
  window.location.href = "/login.html";
}

function logout() {
  localStorage.removeItem("accessToken");
  localStorage.removeItem("refreshToken");
  window.location.href = "/login.html";
}

// =========================
// CARICA PROFESSORI
// =========================

async function caricaProfessori() {
  const res = await fetch("/api/professori", {
    headers: { "Authorization": "Bearer " + token }
  });

  const professori = await res.json();

  const select = document.getElementById("professore");
  select.innerHTML = "<option value=''>Seleziona professore</option>";

  professori.forEach(p => {
    const option = document.createElement("option");
    option.value = p.id;
    option.textContent = p.nome;
    select.appendChild(option);
  });
}

// =========================
// CARICA SLOT IN FORMATO CALENDARIO
// =========================

async function caricaSlot() {

  const professore_id = document.getElementById("professore").value;

  if (!professore_id) {
    document.getElementById("calendar").innerHTML = "";
    return;
  }

  const res = await fetch("/api/slots?professore_id=" + professore_id, {
    headers: { "Authorization": "Bearer " + token }
  });

  const data = await res.json();

  // =========================
  // GENERA LUN-VEN SETTIMANA CORRENTE (NO TIMEZONE BUG)
  // =========================

// =========================
// GENERA LUN-VEN SETTIMANA CORRENTE (SENZA BUG)
// =========================

const oggi = new Date();
const lunedi = new Date(oggi);

const giornoSettimana = oggi.getDay();
const diff = (giornoSettimana === 0 ? -6 : 1) - giornoSettimana;
lunedi.setDate(oggi.getDate() + diff);

const giorni = [];
const etichette = ["LUN", "MAR", "MER", "GIO", "VEN"];

for (let i = 0; i < 5; i++) {
  const d = new Date(lunedi);
  d.setDate(lunedi.getDate() + i);

  const yyyy = d.getFullYear();
  const mm = String(d.getMonth() + 1).padStart(2, "0");
  const dd = String(d.getDate()).padStart(2, "0");

  giorni.push({
    data: `${yyyy}-${mm}-${dd}`,
    label: etichette[i]
  });
}

  // =========================
  // GENERA ORARI FISSI 12:00-19:00
  // =========================

  function generaOrari() {
    const orari = [];
    let ora = 12;
    let minuti = 0;

    while (ora < 19 || (ora === 19 && minuti === 0)) {
      const h = String(ora).padStart(2, "0");
      const m = String(minuti).padStart(2, "0");
      orari.push(`${h}:${m}`);

      minuti += 15;
      if (minuti === 60) {
        minuti = 0;
        ora++;
      }
    }

    return orari;
  }

  const orari = generaOrari();

  // =========================
  // COSTRUZIONE TABELLA
  // =========================

  const calendarDiv = document.getElementById("calendar");
  calendarDiv.innerHTML = "";

  const table = document.createElement("table");

  // HEADER
  const headerRow = document.createElement("tr");
headerRow.innerHTML =
  "<th>Ora</th>" +
  giorni.map(g => {
    return `<th>${g.label}</th>`;
  }).join(""); 
    .join("");

  table.appendChild(headerRow);

  // RIGHE
  orari.forEach(ora => {
    const row = document.createElement("tr");
    let rowHTML = `<td class="ora">${ora}</td>`;

 giorni.forEach(g => {

const slot = data.find(s => {
  const dataDB = s.giorno.split("T")[0];  // elimina eventuale parte oraria
  return dataDB === g.data && s.ora_inizio === ora;
});

      if (!slot) {
        rowHTML += "<td style='background:#f0f0f0; opacity:0.4;'></td>";
      } else {

        let classe = "";
        let simbolo = "";

        if (slot.mio) {
          classe = "mio";
          simbolo = "ðŸ”µ";
        } else if (slot.prenotato == 0) {
          classe = "libero";
          simbolo = "ðŸŸ¢";
        } else {
          classe = "occupato";
          simbolo = "ðŸ”´";
        }

        rowHTML += `<td class="${classe}" data-id="${slot.id}">${simbolo}</td>`;
      }
    });

    row.innerHTML = rowHTML;
    table.appendChild(row);
  });

  calendarDiv.appendChild(table);

  // CLICK HANDLER
  calendarDiv.querySelectorAll("td[data-id]").forEach(cell => {
    cell.onclick = () => {
      const id = cell.dataset.id;
      const slot = data.find(s => s.id == id);

      if (slot.mio) {
        if (confirm("Vuoi annullare la prenotazione?")) {
          annulla(id);
        }
      } else if (slot.prenotato == 0) {
        if (confirm("Vuoi prenotare questo slot?")) {
          prenota(id);
        }
      }
    };
  });
}
// =========================
// PRENOTA
// =========================

async function prenota(slotId) {
  const res = await fetch("/api/prenota", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + token
    },
    body: JSON.stringify({ slotId })
  });

  const data = await res.json();

  if (res.ok) {
    caricaSlot();
  } else {
    alert(data.error);
  }
}

// =========================
// ANNULLA
// =========================

async function annulla(slotId) {
  const res = await fetch("/api/annulla", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + token
    },
    body: JSON.stringify({ slotId })
  });

  const data = await res.json();

  if (res.ok) {
    caricaSlot();
  } else {
    alert(data.error);
  }
}



caricaProfessori();

</script>

</body>
</html>
