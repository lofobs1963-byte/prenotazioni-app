<!DOCTYPE html>
<html>
<head>
  <title>Area Studente</title>
  <style>
    .slot {
      display: inline-block;
      padding: 8px;
      margin: 5px;
      border: 1px solid black;
      cursor: pointer;
    }
    .libero { background-color: #b6fcb6; }
    .occupato { background-color: #ff7b7b; }
    .mio { background-color: orange; }
  </style>
</head>
<body>

<h2>Area Studente</h2>
<button onclick="logout()">Logout</button>

<select id="professore" onchange="caricaSlot()"></select>
<br><br>

<div id="slots"></div>

<script>
const token = localStorage.getItem("token");

if (!token) {
  window.location.href = "/login.html";
}

function logout() {
  localStorage.removeItem("token");
  window.location.href = "/login.html";
}

async function caricaProfessori() {
  const res = await fetch("/professori-studente", {
    headers: { "Authorization": "Bearer " + token }
  });

  const professori = await res.json();

  const select = document.getElementById("professore");
  select.innerHTML = "<option value=''>Seleziona professore</option>";

  professori.forEach(p => {
    const option = document.createElement("option");
    option.value = p.id;
    option.textContent = p.nome;
    select.appendChild(option);
  });
}

async function caricaSlot() {

  const professore_id = document.getElementById("professore").value;

  if (!professore_id) {
    document.getElementById("slots").innerHTML = "";
    return;
  }

  const res = await fetch("/slots?professore_id=" + professore_id, {
    headers: { "Authorization": "Bearer " + token }
  });

  const data = await res.json();

  const container = document.getElementById("slots");
  container.innerHTML = "";

  data.forEach(slot => {
    const div = document.createElement("div");
    div.classList.add("slot");

    if (slot.mio) {
      div.classList.add("mio");
    } else if (slot.prenotato == 0) {
      div.classList.add("libero");
    } else {
      div.classList.add("occupato");
    }

    div.innerText = slot.giorno + " " + slot.ora_inizio + "-" + slot.ora_fine;

   if (slot.mio) {
  div.onclick = () => annulla(slot.id);
} else if (slot.prenotato == 0) {
  div.onclick = () => prenota(slot.id);
}

    container.appendChild(div);
  });
}

async function prenota(slotId) {
  const res = await fetch("/prenota", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + token
    },
    body: JSON.stringify({ slotId })
  });

  const data = await res.json();

  if (res.ok) {
    caricaSlot();
  } else {
    alert(data.error);
  }
}

async function annulla(slotId) {
  const res = await fetch("/annulla", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + token
    },
    body: JSON.stringify({ slotId })
  });

  const data = await res.json();

  if (res.ok) {
    caricaSlot();
  } else {
    alert(data.error);
  }
}

caricaProfessori();

</script>


</body>
</html>
